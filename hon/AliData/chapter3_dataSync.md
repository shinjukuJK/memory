<head>
<link href = '../../css/notestyle.css' rel = 'stylesheet' type = 'text/css'>
</head>

# 阿里巴巴大数据之路第3章：数据同步
* 数据从业务系统同步进入数据仓库，以及数仓到数据服务以及应用
## 数据同步基础
### 直连同步
* 数仓直连业务系统数据库，配置简单，但对业务系统压力较大。
### 数据文件同步
* 适用于数据源包含多个异构数据库系统（mysql、oracle），需注意同时配套校验文件，避免丢包等异常情况导致数据缺失。
### 数据库日志解析同步
* 目前最广泛使用的同步方式，对业务系统压力较小，通过数据库日志还原也更为自由准确。但也存在一定缺点，抽取日志投入较大，数据在业务系统批量补录等情况下也可能存在延迟。
## 阿里数仓同步方式
### 批量数据同步
* 增加数据中间态，将所有源数据库系统的数据类型统一转换为字符串类型，实现数据格式统一。
* DataX作为业务系统内的插件使用，采用Framework+Plugin开放式框架实现。
* JOB→splitter切分→subjob（task）→reader→channel→writer
### 实时数据同步
* 日志数据交换中心，从多服务器实时读取日志数据，并通知所有订阅该部分消息的数仓系统来获取。
## 数据同步遇到的问题与解决方案
### 分库分表处理
* 建立一个中间逻辑表，将分布在不同数据库中不同表集成为一个表。
### 高效同步和批量同步
* 将数据同步配置透明化、简化，降低人力投入。
### 增量与全量同步的合并
* 传统数据合并大多采用merge，阿里推荐方式为全外连接（full outer join）+数据全量覆盖重新加载（insert overwrite）
* 若考虑到数据更新错误问题，可以采用分区方式，区分版本同时存储。（数据快照）
### 同步性能处理
* 通过目标数据库的元数据估算同步任务的总线程数以及业务优先级，提升同步任务的执行效率以及稳定性。
### 数据漂移的处理
* 进入数仓第一层数据称为ODS层，数据漂移指ODS数据同一个业务日期数据中包含前一天或后一天凌晨附近的数据，或者丢失当天的变更数据。
* 原因在于时间戳字段分为四类：  
  数据库表中标识数据更新字段(modified_time);  
  数据库日志标识数据记录更新时间(log_time);  
  数据库表记录业务过程发生时间(proc_time);  
  标识数据记录被抽取到时间(extract_time);  
  理想情况下这几个时间应该一致，但实际生产中难免因为业务系统未更新、数据抽取时间、网络压力等原因，出现差异。
* 处理办法是多个时间戳组合，例如先通过log_time冗余前后各15分钟的数据，并用modified_time过滤非当天时间，确保数据不会因为系统问题遗漏，最后再根据proc_time明确定位漂移数据，再进行数据回补



